---
title: "Capture mark recapture analysis of green turtles"
author: "Tomo Eguchi"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default

---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls())

knitr::opts_chunk$set(echo = TRUE)

library(jagsUI)
library(tidyverse)
library(lubridate)
library(reshape)
#library(bayesplot)
#library(ggridges)
library(RMark)
library(R2ucare)
#library(loo)
library(kableExtra)

source("Mancini_functions.R")
save.fig <- T
fig.height <- 4
fig.width <- 6

# a function to replace parentheses with brackets
# With parentheses, table entries are read as TeX, resulting in subscripts
# With brackets, they are all read as characters - must be a better way to
# deal with this stuff but couldn't find one 2021-01-08
paren2bracket <- function(df.in){
  tmp <- gsub("(", "[", df.in, fixed = T)
  tmp <- gsub(")", "]", tmp, fixed = T)
  return(tmp)
}

table.id <- 1
figure.id <- 1
# tilde12dot <- function(df.in){
#   tmp <- gsub("~1", ".", df.in, fixed = T)
#   return(tmp)
# }

```

## Methods {-}

(I think a lot of this stuff can be in appendix. We can just provide results for a couple places.)

To estimate survival rate and abundance of green turtles, Cormack-Jolly-Seber (CJS) models were fitted to the capture-recapture dataset for green turtles. Results indicated that apparent changes in abundance might have been caused by sampling inequalities among study sites. In order to remove the inequalities, CJS models were fitted to data from each study site independently. This was justified by the lack of movements by turtles among the study sites. 

Briefly, the CJS model uses the capture history of each individual without assuming that the population is closed. There are two main parameters in the basic model; survival rate (Phi) and capture/recapture probability (p).  The abundance may be estimated through the Horvitz-Thompson estimator, where the number of captured individuals per sampling period is divided by the estimated capture probability for that time period. The estimated survival rate should be considered as an apparent survival rate as the permanent emigrant is considered as dead.  Effects of transients, however, can be determined.   

The basic model can be extended to accommodate various modifications, such as time-dependent survival rates, time-dependent capture probability, covariate-dependent survival rates and capture probabilities.

Communities with small proportions (< 0.05) of recaptures, i.e., the number of individuals caught more than once in the total number of individuals, were excluded from the analysis because of insufficient numbers of recaptures. 

Capture history data from each study area with sufficient numbers of recaptures were pooled by sampling seasons (summer and winter). In other words, multiple captures within each season were treated as one capture. 

I considered several possible CJS models for this analysis. For survival rates, they were treated as either constant or affected by transients (time-since-marking; tsm). For capture probabilities, they were treated as either constant, time dependent, different between the first and subsequent captures (trap response), different between summer and winter, or a function of effort. A total of 14 models were fitted to the data (Table \@ref(tab:model-defs)).

Capture-recapture data of green turtles were separated into study areas and CJS models were fitted using Mark (White and Cooch Yr) via RMark (v. `r packageVersion("RMark")`, Laake 2013, Laake, J.L. (2013). RMark: An R Interface for Analysis of Capture-Recapture Data with MARK. AFSC Processed Rep 2013-01, 25p. Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 7600 Sand Point Way NE, Seattle WA 98115.). Some capture events in the beginning of a few time series were deleted because of the small numbers of captures. For each location, fit of various models were compared using AICc. Parameters estimates from the model with the smallest AICc value are reported. We used UCare through R2ucare (v. `r packageVersion("R2ucare")`, Olivier Gimenez, Jean-Dominique Lebreton, Remi Choquet and Roger Pradel (2017). R2ucare: Goodness-of-Fit Tests for Capture-Recapture Models. R package version 1.0.0. https://CRAN.R-project.org/package=R2ucare) to test for goodness-of-fit. 

The best models for each location were also fitted using the Bayesian equivalent (Kery an Schaub 2012; Bayesian population analysis using WinBUGS. Academic Press, Elsevier, Waltham MA, USA) using JAGS (v. 4.3.0, Plummer 2017) via the jagsUI package (v. `r packageVersion("jagsUI")`, Kellner 2019, Ken Kellner (2019). jagsUI: A Wrapper Around 'rjags' to Streamline 'JAGS' Analyses. R package version 1.5.1. https://CRAN.R-project.org/package=jagsUI) in R (`r paste0(R.Version()$major, ".", R.Version()$minor)`, R Core Team). To obtain the joint posterior distribution of parameters through Markov chain Monte Carlo (MCMC), we ran 5 chains of 50,000 steps where the first 30,000 samples were discarded as burn-in samples. The remaining 20,000 samples were thinned by taking every five sample. Posterior distributions were summarized using the resulting 20,000 samples (4,000 x 5 chains). Convergence of MCMC was determined using Gelman-Rubin statistics.  

Using the two different approaches to analyze the capture-recapture data allowed us to determine if reliable estimates were obtained for each dataset, especially with small numbers of recaptures. Although the model structures between the maximum-likelihood and Bayesian approaches are different, estimates should be similar if the data supported the models. We graphically show the correlation between estimates obtained from the two approaches. In the best case scenario, the estimates from the two approaches should fall on the y=x line with similar uncertainties. Large departures between the approaches indicate that estimates are likely not reliable.  


```{r data, echo=FALSE, include=T}

dat.1.Cm <- get.data.Cm("data/GTC_Cm Data_updated_2020-04-28_TE_v2.csv")

# Group by community and create CJS data for each community
community.names <- levels(as.factor(dat.1.Cm$community))
```


```{r RMark, echo=FALSE, include=T}
# Analyses were completed in Cm_CJS_v3_Mark_community.Rmd
# some communities don't have enough recaptures to do CMR modeling
c <- 0
k <- 18
p.recap <- vector(mode = "numeric")
community.names.used <- vector(mode = "character")
Cm.results <- Cm.CJS.input <- vector(mode = "list")

for (k in 1:length(community.names)){
    dat.1.Cm.community <- filter(dat.1.Cm, community == community.names[k])
    CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
    n.GT2.cap <- length(which(rowSums(CJS.data$data) > 1))
    p.recap[k] <- n.GT2.cap/nrow(CJS.data$data)

    if (p.recap[k] > 0.05){
      community.names.used[c + 1] <- community.names[k]
    }
    
  if (file.exists(paste0("RData/CJS_Cm_RMark_", community.names[k], ".rds"))){
    Cm.results[[c+1]] <- readRDS(file = paste0("RData/CJS_Cm_RMark_", 
                                               community.names[k], ".rds"))
    Cm.CJS.input[[c+1]] <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", 
                                                 community.names[k], ".rds"))
      c <- c + 1
  } 
  
}

mark.table <- model.table(Cm.results[[1]]) %>% rownames_to_column(var = "ID")
# 
mark.table$Model <- paren2bracket(mark.table$model) #%>% tilde12dot()

```

```{r model-defs, echo=F}

# tmp <- gsub("(", "[", mark.table$model, fixed = T)
# tmp <- gsub(")", "]", tmp, fixed = T)

knitr::kable(mark.table %>% select(ID, Model) %>% arrange(by = as.numeric(ID)),
             digits = 2,
             caption = "Definitions of 14 CJS models fitted to CMR data of green turtles. '~1' indicates a constant.",
             table.attr = "style='width:30%;'",
             booktabs = TRUE) 
#%>%
#  row_spec(14, hline_after = T)

```

## Results {-}
Of ```r length(community.names)``` communities, only ```r length(community.names.used)``` communities contained sufficient recaptures. Data for  ```r length(community.names) - length(community.names.used)```  communities were not used in the following analysis. Goodness of fit of CJS models was examined for each study area. Results from each community are provided separately in the following sections.

### Goodness of fit {-}

These results should be in a supplementary material. 

```{r GOF, echo=F, include=F, cache=T, warning=F}

overall_Cm <- test3sr_Cm <- test3sm_Cm <- test2ct_Cm <- test2cl_Cm <- vector(mode = "list")

for (k in 1:length(community.names.used)){
  output.filename <- paste0("RData/CJS_Cm_RMark_input_", community.names.used[k], ".rds")
  
  results.k <- readRDS(file = output.filename)
  #CH.Ucare <-R2ucare::group_data(CJS.data$data, effX = rep(1, nrow(CJS.data$data)))
  CH.Ucare <- results.k$CH.R2ucare
  
  overall_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = overall_CJS(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                                 freq = CH.Ucare$effY)) 
  
  test3sr_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test3sr(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY)) 
  
  test3sm_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test3sm(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
  
  test2ct_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test2ct(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
  
  test2cl_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test2cl(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
}


overall.GOF <- lapply(overall_Cm, 
                      FUN = function(x) out.list <- list(community  = x$community, 
                                                         Chi2 = x$test.out$chi2,
                                                         df = x$test.out$degree_of_freedom,
                                                         p_val = x$test.out$p_value,
                                                         c_hat = signif(x$test.out$chi2/x$test.out$degree_of_freedom, 3)))

overall.GOF.df <- data.frame(do.call(rbind, overall.GOF))

```

#### Overall test {-}

GNO returns NAN in test results because 23rd occasion returns NaN for its statistic. I'm not sure what's causing this. Results for GNO do not look good so it may be good to remove this dataset from further analysis. Among all four tests, test3.sr was the only one that contained NAs for GNO. 

```{r check_GNO_data, echo=F, include=F}
output.filename <- paste0("RData/CJS_Cm_RMark_input_GNO.rds")
GNO_data <- readRDS(file = output.filename)
#CH.Ucare <-R2ucare::group_data(CJS.data$data, effX = rep(1, nrow(CJS.data$data)))
CH.Ucare <- GNO_data$CH.R2ucare
GNO_overall <- overall_CJS(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                           freq = CH.Ucare$effY)



```

According to the GOF tests, all c-hat values were acceptable (Table \@ref(tab:table-overall-GOF)).  

```{r table-overall-GOF, echo=F, include=T}
knitr::kable(overall.GOF.df, 
             digits = 2,
             col.names = c("Community", "Chi2", "df", "p val", "c-hat"),
             caption = "Results from overall goodness-of fit",
             table.attr = "style='width:30%;'")

```

#### TEST3.SR {-}
TEST3.SR asks "of those individuals seen either on or before occasion (i), what proportion were ever seen again?" According to the Book (Mark Book), it states that "If TEST3.SR is rejected, then this suggests that there is a difference in 'survival' among individuals, depending on whether or not they were seen for the first time either on or before occasion (i)." 

All datasets passed Test3.sr, except GNO, which resulted in NaN (Table \@ref(tab:table-test3sr)).

```{r test3sr, echo=FALSE, include=T}
test3sr.overall <- lapply(test3sr_Cm, 
                         FUN = function(x){out.list <- list(community  = x$community, 
                                                            stat = unname(x$test.out$test3sr["stat"]),
                                                            df = unname(x$test.out$test3sr["df"]),
                                                            p_val = unname(x$test.out$test3sr["p_val"]),
                                                            sign_test = unname(x$test.out$test3sr["sign_test"]))
                         return(out.list)})

test3sr.overall.df <- data.frame(do.call(rbind, test3sr.overall))
```


```{r table-test3sr, echo=F, include=T}
knitr::kable(test3sr.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val", "signed test"),
             caption = "Results from Test3.sr, which evaluates difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once",
             table.attr = "style='width:30%;'")

```

#### TES3.Sm {-}

TEST3.Sm tests the hypothesis that there is no difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once. It looks at individuals who were seen again. "Among these individuals seen again, when they were seen again does not depend on whether or not they were seen for the first time at occasion (i)."

```{r test3.sm, echo=F, include=F, cache=T}
test3sm.overall <- lapply(test3sm_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test3sm["stat"]),
                                                             df =  unname(x$test.out$test3sm["df"]),
                                                             p_val = unname(x$test.out$test3sm["p_val"])))


test3sm.overall.df <- data.frame(do.call(rbind, test3sm.overall))
```

All datasets passed test3.sm (Table \@ref(tab:table-test3sm)).

```{r table-test3sm, echo=F, include=T}
knitr::kable(test3sm.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val"),
             caption = "Results from Test3.sm, which evaluates difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once",
             table.attr = "style='width:30%;'")
```

#### TEST2.CT {-}

TEST2.CT tests the hypothesis that "there is no difference in the probability of being recaptured at t+1 between those captured and not captured at occasion t, conditional on presence at both occasions.  

```{r test2ct, echo=F, include=F}
test2ct.overall <- lapply(test2ct_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test2ct["stat"]),
                                                             df =  unname(x$test.out$test2ct["df"]),
                                                             p_val = unname(x$test.out$test2ct["p_val"]),
                                                             sign_test = unname(x$test.out$test2ct["sign_test"])))


test2ct.overall.df <- data.frame(do.call(rbind, test2ct.overall))
```

All datasets passed test2.ct except PAO (Table \@ref(tab:table-test2ct)).

```{r table-test2ct, echo=F, include=T}
knitr::kable(test2ct.overall.df, 
             digits = 2,
             col.names = c("Community", "stat", "df", 
                           "p val", "signed test"),
             caption = "Results from Test2.ct, which evaluates difference in the probability of being recaptured at t+1 between those captured and not captured at occasion t, conditional on presence at both occasions",
             table.attr = "style='width:30%;'")
```

#### TEST2.CL {-}

TEST2.CL tests if there is no difference in the expected time of next capture between the individuals captured and not captured at occasion t conditional on presence at both occasions t and t + 2.  

```{r test2cl, echo=F, include=F, warning=F}
# The null hypothesis being tested in TEST2.CL is that there is no difference in
# the expected time of next recapture between the individuals captured and not captured at occasion i
# conditional on presence at both occasions i and i+2. To date, this test has no ‘simple’ interpretation, but
#it is a component test of the overall TEST2 fit statistic.
test2cl.overall <- lapply(test2cl_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test2cl["stat"]),
                                                             df =  unname(x$test.out$test2cl["df"]),
                                                             p_val = unname(x$test.out$test2cl["p_val"])))


test2cl.overall.df <- data.frame(do.call(rbind, test2cl.overall))
```

All datasets passed test2.cl (Table \@ref(tab:table-test2cl)).

```{r table-test2cl, echo=F, include=T}
knitr::kable(test2cl.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val"),
             caption = "Results from Test2.cl, which evaluates the expected time of next capture between the individuals captured and not captured at occasion t conditional on presence at both occasions t and t + 2",
             table.attr = "style='width:30%;'")

```

All tests indicate that almost all datasets passed the GOF tests. (except Test3.sr for GNO, which resulted in NAs... and PAO Test2.ct, which had p < 0.05) 

For the following analyses, estimated capture probabilities that were less than 0.001 were considered unreliable and eliminated. 


### Demographic parameter estimates {-}

```{r selected_models, echo=FALSE}
community.names <- c("BKS", "BMA", "GNO", 
                     "IES", "LSI", "MUL",
                     "PAO", "PLM")

# Because of absurdly small survival rate estimates for Phidot models, I changed them to 
# phiTSM models - they were the second best models for those communities
# BKS: Phidot_pt (2) -> PhiTSM_pt (11)
# LSI: Phidot_pt (2) -> PhiTSM_pt (11)
# MUL: Phidot_pdot (1) -> PhiTSM_pdot (10)
# PAO: Phidot_pt (2) -> PhiTSM_pt (11)
models.MARK <- data.frame(community = community.names,
                          ID = c(11, 10, 11,
                                 11, 11, 10,
                                 11, 11),
                          model = c("PhiTSM_pt", "PhiTSM_pdot", "PhiTSM_pt",
                                    "PhiTSM_pt", "PhiTSM_pt", "PhiTSM_pdot",
                                    "PhiTSM_pt", "PhiTSM_pt"))

# For GNO, Phi[TSM]p[t] resulted in near 1 survival rate estimate, so used the second best
# model, which was Phi[~1]p[t]
models.MARK.old <- data.frame(community = community.names,
                          ID = c(2, 10, 2,
                                 11, 2, 1,
                                 2, 11),
                          model = c("Phidot_pt", "PhiTSM_pdot", "Phidot_pt",
                                    "PhiTSM_pt", "Phidot_pt", "Phidot_pdot",
                                    "Phidot_pt", "PhiTSM_pt"))



```


#### BKS {-}

```{r capture_history_BKS, echo=FALSE}
loc <- "BKS"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset, which contained ```r ncol(CJS.data$data)``` capture occasions from ```r colnames(CJS.data$data)[1]``` to ```r colnames(CJS.data$data)[ncol(CJS.data$data)]```. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to be included in CMR analyses (Figure \@ref(fig:plot-recap-n-BKS)). Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis (Figure \@ref(fig:plot-Cap-His-BKS). 


```{r plot-recap-n-BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at BKS. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were ```r ncol(Cm.inputs$CJS.data$data)``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)``` (Figure \@ref(fig:plot-recap-n-BKS). The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure \@ref(fig:plot-Cap-n-BKS). 


```{r plot-Cap-His-BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at BKS. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot-Cap-n-BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at BKS. "}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```


##### Mark (Phi[.]p[t]) {-}
For this study area, the best model was a constant survival and time-dependent capture probabilities (Phi[~1]p[time], \@ref(tab:table-model-BKS)). The second best model with $\delta$AICc = 1.45 (Phi[tsm]p[time]) indicated survival may be a function of time-since-marking, which is an evidence of presence of transient animals.   

```{r model_comp_BKS, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

BKS.models.df <- model.table(Cm.results.Mark) %>% 
  select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>% tilde12dot()
```


```{r table-models-BKS, echo=F, include=T}
knitr::kable(BKS.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_BKS, echo=F, include=F}

real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)

```


Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). The wide confidence interval indicated that this estimate is not very reliable. 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-BKS)).


```{r plot-Nhats-BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze the capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian {-}

```{r parameter_estimates_jags_v5_BKS, echo=F, include=F}
# v5 means that the same model and dataset as what Mark selected. 

N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate was ```r signif(N.Phi.hats.Jags$Phihats$mean, 3)``` (SD = ```r signif(N.Phi.hats.Jags$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats.Jags$Phihats$ucl, 2)```]). These estimates are less than those from Mark. I'm not sure what's happening here. They should be the same model. I looked for obvious errors, e.g., incorrect model files, model statements, etc. But, I did not find anything there. This needs to be investigated a bit more. 2021-08-16. 

I think the problem is the recapture rate is very small - the vast majority of turtles were caught just once. Does Mark drop those that were caught just once? It makes no sense to have such high survival rate if many were caught just once... 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty (Figure \@ref(fig:plot-Nhats-jags-v5-BKS)), which likely resulted from small numbers of recaptures. These estimates were significantly lower than those from MARK (\@ref(fig:plot-Nhats-comparison-BKS)). 

```{r plot-Nhats-jags-v5-BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the Bayesian approach, the Phi[~1]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_BKS, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS using MLE (Mark) and the Bayesian approach and the Phi[.]p[t] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```


They don't look so good. Probably not a good idea to provide estimates for this location. 


#### BMA {-}

```{r capture_history_BMA, echo=FALSE}
loc <- "BMA"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. The entire dataset was used for the analysis, including the capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE)` (Figure \@ref(fig:plot-cap-his-BMA)). 


There were `r ncol(Cm.inputs$CJS.data$data)` capture occasions and the number of captured turtles per capture occasion ranged from `r min(n.caught, na.rm = T)` to `r max(n.caught, na.rm = T)` (Figure \@ref(fig:plot-recap-n-BMA)). The number of captures per individual ranged from `r min(rowSums(CJS.data$data))` to `r max(rowSums(CJS.data$data))` with the median of `r median(rowSums(CJS.data$data))` and the mean of `r signif(mean(rowSums(CJS.data$data)), 2)` (Figure \@ref(fig:plot-Cap-n-BMA)). 

```{r plot-Cap-His-BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Capture histories of tagged green turtles at BMA. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot-recap-n-BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at BMA. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

```{r plot-Cap-n-BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of times individual green turtles were captured at BMA. "}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}
```{r model_comp_BMA, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

BMA.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

Six models were within $\delta$AICc < 4, where all of them included Phi[TSM]. The best model was Phi[TSM]p[.] (Table \@ref(tab:table-models-BMA)). 

```{r table-models-BMA, echo=F, include=T, warning=FALSE, message=FALSE}
knitr::kable(BMA.models.df, 
             digits = 2,
             col.names = c("model", "deltaAICc"),
             row.names = F,
             caption = "Model comparison for community BMA",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_BMA, echo=F}

real.estimates <- Cm.results.Mark$Phi.tsm.p.dot$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)

```

Using the best model, the survival rate of residents was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[2, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[2, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[2, "ucl"], 2)`]). 

The proportion of residents was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)`, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)` to `r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")` (Figure \@ref(fig:plot-Nhats-BMA)).

```{r plot-Nhats-BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles including transients at BMA when the maximum likelihood approach and the Phi[TSM]p[~1] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian {-}

###### Using the same data and model as Mark (Phi[tsm]p[.]) {-}

```{r parameter_estimates_jags_v5_BMA, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "BMA"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (`r models.MARK.old %>% filter(community == loc) %>% select(model)`), the estimated mean survival rate of residents was `r signif(N.Phi.hats.Jags$Gammahats[2, "mean"], 3)` (SD = `r signif(N.Phi.hats.Jags$Gammahats[2, "sd"], 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Gammahats[2, "lcl"], 2)` - `r signif(N.Phi.hats.Jags$Gammahats[2, "ucl"], 2)`]). These estimates are similar to those from the maximum likelihood estimates. 

The proportion of residents was estimated to be `r signif(N.Phi.hats.Jags$Gammahats[1,"mean"]/N.Phi.hats.Jags$Gammahats[2,"mean"], 3)`, using the two survival rates (one for transients and residents and another for residents only), which was higher than the estimate from the maximum likelihood approach (0.21). 

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)` (Figure \@ref(fig:plot-Nhats-jags-v5-BMA)). These estimates were also similar to those from the ML approach (Figure \@ref(fig:plot-Nhats-comparison-BMA)).  

```{r plot-Nhats-jags-v5-BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles including transients at BMA when the Bayesian approach, the Phi[tsm]p[.] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_BMA, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at BMA using MLE (Mark) and the Bayesian approach and the Phi[tsm]p[.] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```


These estimates (Mark and Jags) are very close to each other and I feel good about them! :)


#### GNO {-}

```{r capture_history_GNO, echo=FALSE}
loc <- "GNO"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

# DATE for GNP_200228_1_Cm_01 is missing. 
```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. However, the numbers of turtles caught per capture occasion before `r Cm.inputs$first.sample.date` were insufficient to include in CMR analyses and excluded (Figure \@ref(fig:plot-recap-n-GNO)). Consequently, the capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE, na.rm = T)` were used in the analysis (Figure \@ref(fig:plot-Cap-His-GNO)). 


```{r plot-recap-n-GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at GNO. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were `r ncol(Cm.inputs$CJS.data$data)` capture occasions and the number of captured turtles per capture occasion ranged from `r min(n.caught, na.rm = T)` to `r max(n.caught, na.rm = T)` (Figure \@ref(fig:plot-recao-n-GNO)). The number of captures per individual ranged from `r min(rowSums(CJS.data$data))` to `r max(rowSums(CJS.data$data))` with the median of `r median(rowSums(CJS.data$data))` and the mean of `r signif(mean(rowSums(CJS.data$data)), 2)` (Figure \@ref(fig:plot-Cap-n-GNO)). 


```{r plot-Cap-His-GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Capture histories of tagged green turtles at GNO. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot-Cap-n-GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of times individual green turtles were captured at GNO. "}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}
```{r model_comp_GNO, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

GNO.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

```{r table-models-GNO, echo=F, include=T}
knitr::kable(GNO.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```



```{r parameter_estimates_TSM_GNO, echo=F, warning=FALSE, message=FALSE}
real.estimates <- Cm.results.Mark$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.TSM.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

#plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)
#plot.Nhats.Jags(loc, N.Phi.hats.Jags.TSM, save.fig, fig.height, fig.width, ext = "jags_TSM.png")

```

Although Phi[tsm]p[t] was the best model (Table \@ref(tab:table-models-GNO)), the mean estimate of the survival rate of residents and transients was virtually 1.0 (mean = `r N.Phi.p.hats.TSM.Mark$Phihats[1, "estimate"]`) and its confidence interval ranged from virtually 0 to 1.0 . The second best model was only `r signif(GNO.models.df[2, "DeltaAICc"], 2)` AICc units away from the best model. Consequently, we used the second best model (Phi[.]p[t]) to make inference. 

```{r parameter_estimates_GNO, echo=F, warning=FALSE, message=FALSE}
real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)
#plot.Nhats.Jags(loc, N.Phi.hats.Jags.TSM, save.fig, fig.height, fig.width, ext = "jags_TSM.png")

```


```{r plot-Nhats-GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles at GNO when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

Using the Phi[.]p[t] model, the survival rate was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)`]). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)` to `r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-GNO)).

##### Bayesian {-}

```{r parameter_estimates_jags_v5_GNO, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "GNO"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width, ext = "jags_v5.png")

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the Phi[.]p[t] model, the estimated mean survival rate was `r signif(N.Phi.hats.Jags$Phihats$mean, 3)` (SD = `r signif(N.Phi.hats.Jags$Phihats$sd, 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Phihats$lcl, 3)` - `r signif(N.Phi.hats.Jags$Phihats$ucl, 3)`]), which was less than the estimates from the ML approach.

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)` with large uncertainty (Figure \@ref(fig:plot-Nhats-jags-v5-GNO)). 

```{r plot-Nhats-jags-v5-GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles including transients at GNO when the Bayesian approach, the Phi[.]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

Compare Nhats from Mark and Jags:

```{r Nhats_comparison_GNO, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at GNO using MLE (Mark) and the Bayesian approach and the Phi[.]p[t] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```


There were large differences between abundance estimates from MLE and Bayesian approaches (Figure \@ref(fig:plot-Nhats-comparison-GNO)).

Not very good. Mark's estimates are a lot higher than those from Jags. There were some NAs in Nhat estiamtes for Mark as well... probably not a good one to provide estimates. 


#### IES {-}

```{r capture_history_IES, echo=FALSE}
loc <- "IES"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. However, the numbers of turtles caught per capture occasion before `r Cm.inputs$first.sample.date` were insufficient to include in CMR analyses and excluded (Figure \@ref(fig:plot-recap-n-IES)). Consequently, the capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE)` were used in the analysis (Figure \@ref(fig:plot-Cap-His-IES)). 


```{r plot-recap-n-IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at IES. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were `r ncol(Cm.inputs$CJS.data$data)` capture occasions and the number of captured turtles per capture occasion ranged from `r min(n.caught, na.rm = T)` to `r max(n.caught, na.rm = T)`. The number of captures per individual ranged from `r min(rowSums(CJS.data$data))` to `r max(rowSums(CJS.data$data))` with the median of `r median(rowSums(CJS.data$data))` and the mean of `r signif(mean(rowSums(CJS.data$data)), 2)` (Figure \@ref(fig:plot-Cap-n-IES)). 


```{r plot-Cap-His-IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Capture histories of tagged green turtles at IES. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot-Cap-n-IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of times individual green turtles were captured at IES."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}

```{r model_comp_IES, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

IES.models.df <- model.table(Cm.results.Mark) %>% 
  select( model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

```{r table-models-IES, echo=F, include=T}
knitr::kable(IES.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_IES, echo=F, warning=FALSE, message=FALSE}
real.estimates <- Cm.results.Mark$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA
plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)

```


Using the best model (Phi[tsm]p[t], Table \@ref(tab:table-models-IES)), the estimated mean survival rate of residents was `r signif(N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[2, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[2, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[2, "ucl"], 2)`]). 

The proportion of residents was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)`, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)` to `r signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-IES)).


```{r plot-Nhats-IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles including transients when the maximum likelihood approach and the Phi[tsm]p[t] model were used to analyze capture histories. Black filled circles indicate the means and error bars are 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian {-}

```{r parameter_estimates_jags_v5_IES, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "IES"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

#format(signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (`r models.MARK.old %>% filter(community == loc) %>% select(model)`), the estimated mean survival rate of residents was `r signif(N.Phi.hats.Jags$Gammahats[2, "mean"], 3)` (SD = `r signif(N.Phi.hats.Jags$Gammahats[2, "sd"], 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Gammahats[2, "lcl"], 3)` - `r signif(N.Phi.hats.Jags$Gammahats[2, "ucl"], 2)`]), these estimates are similar to that from the ML approach (`r signif(N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)`).

The proportion of residents was estimated to be `r signif(N.Phi.hats.Jags$Gammahats[1, "mean"]/N.Phi.hats.Jags$Gammahats[2,"mean"], 3)`, which were less than that from the ML approach.  

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(plot-Nhats-jags-v5-IES)). These estimates were significantly lower than those from MARK (Figure \@ref(fig:plot-Nhats-comparison-IES)). Abundance estimates from the two approaches were quite different, where MLEs were generally greater (by 10x) than Bayesian estimates. I don't have confidence in these estimates. 

```{r plot-Nhats-jags-v5-IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles including transients at IES when the Bayesian approach, the Phi[TSM]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_IES, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at IES using MLE (Mark) and the Bayesian approach and the Phi[tsm]p[t] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```


#### LSI {-}

```{r capture_history_LSI, echo=FALSE}
loc <- "LSI"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. However, the numbers of turtles caught per capture occasion before `r Cm.inputs$first.sample.date` were insufficient to include in CMR analyses and excluded (Figure \@ref(fig:plot-recap-n-LSI)). Consequently, the capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE)` were used in the analysis (Figure \@ref(fig:plot-Cap-His-LSI)). 


```{r plot-recap-n-LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at LSI. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were `r ncol(Cm.inputs$CJS.data$data)` capture occasions and the number of captured turtles per capture occasion ranged from `r min(n.caught, na.rm = T)` to `r max(n.caught, na.rm = T)`. The number of captures per individual ranged from `r min(rowSums(CJS.data$data))` to `r max(rowSums(CJS.data$data))` with the median of `r median(rowSums(CJS.data$data))` and the mean of `r signif(mean(rowSums(CJS.data$data)), 2)` (Figure \@ref(fig:plot-Cap-n-LSI)). 


```{r plot-Cap-His-LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Capture histories of tagged green turtles at LSI. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot-Cap-n-LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "The number of times individual green turtles were captured at LSI."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}

```{r model_comp_LSI, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

LSI.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

The best model was Phi[.]p[t]. The second best model (Phi[TSM]p[t]) was only `r signif(LSI.models.df[2, "DeltaAICc"], 2)` away from the best model. 

```{r table-models-LSI, echo=F, include=T}
knitr::kable(LSI.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_LSI, echo=F, message=FALSE, warning=FALSE}
real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA
p.LSI <- plot.Nhats.Mark(loc, 
                         N.Phi.p.hats.Mark, 
                         save.fig, 
                         fig.height, 
                         fig.width)

# SEs are zeros for this place... Not worth analyzing. 
```


Using the best model (Phi[.]p[t], \@ref(tab:table-models-LSI)), the survival rate was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1, "estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)`]). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)` to `r signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-LSI)).

```{r parameter_estimate_TSMs_LSI, echo=F, message=FALSE, warning=FALSE}
real.estimates <- Cm.results.Mark$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.TSM.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

```


```{r plot-Nhats-LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at LSI when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_LSI.png"))
```


##### Bayesian {-}

```{r parameter_estimates_jags_v5_LSI, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "LSI"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, 
                N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (`r models.MARK.old %>% filter(community == loc) %>% select(model)`), the estimated mean survival rate was `r signif(N.Phi.hats.Jags$Phihats$mean, 3)` (SD = `r signif(N.Phi.hats.Jags$Phihats$sd, 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Phihats$lcl, 3)` - `r signif(N.Phi.hats.Jags$Phihats$ucl, 3)`]), which was less than the estimates from the ML approach.

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-jags-v5-LSI)). These estimates were significantly lower than those from MARK (Figure \@ref(fig:plot-Nhats-comparison-LSI)). The comparison between estimates from Mark and Jags indicated they were quite different (Mark's estimates were greater than those from Jags). I would not use these estimates. 


```{r plot-Nhats-jags-v5-LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles including transients at LSI when the Bayesian approach, the Phi[.]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_LSI, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at LSI using MLE (Mark) and the Bayesian approach and the Phi[.]p[t] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```

#### MUL {-}

```{r capture_history_MUL, echo=FALSE}
loc <- "MUL"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. However, the numbers of turtles caught per capture occasion before `r Cm.inputs$first.sample.date` were insufficient to include in CMR analyses and excluded (Figure \@ref(fig:plot-recap-n-MUL)). Consequently, the capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE)` were used in the analysis (Figure \@ref(fig:plot-Cap-His-MUL)). 


```{r plot-recap-n-MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at MUL. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were ```r ncol(Cm.inputs$CJS.data$data)``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)``` (Figure \@ref(fig:plot-recap-n-MUL)). The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure \@ref(fig:plot-Cap-n-MUL)). 

There aren't many recaptures for this site. 

```{r plot-Cap-His-MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Capture histories of tagged green turtles at MUL. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot-Cap-n-MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of times individual green turtles were captured at MUL."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}

```{r model_comp_MUL, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

MUL.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

Because of the few recaptures, I don't think it's meaningful to fit CMR models to these data... The model selection process shows that a lot of models were fit equally (\@ref(tab:table-models-MUL)). 


```{r table-models-MUL, echo=F, include=T}
knitr::kable(MUL.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```

```{r parameter_estimates_MUL, echo=F, message=FALSE, warning=FALSE}
real.estimates <- Cm.results.Mark$Phi.dot.p.dot$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)

```


Using the best model, the survival rate was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)`]). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)` to `r signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-MUL)).

```{r plot-Nhats-MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at MUL when the maximum likelihood approach and the Phi[~1]p[~1] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

I think these estimates are not very useful... given the few recaptures. 

##### Bayesian {-}

```{r parameter_estimates_jags_v5_MUL, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "MUL"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (`r models.MARK.old %>% filter(community == loc) %>% select(model)`), the estimated survival rate was `r signif(N.Phi.hats.Jags$Phihats$mean, 3)` (mean, SD = `r signif(N.Phi.hats.Jags$Phihats$sd, 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Phihats$lcl, 3)` - `r signif(N.Phi.hats.Jags$Phihats$ucl, 3)`]).

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-jags-v5-MUL)). The comparison between estimates from Mark and Jags were not exactly horrible (Figure \@ref(fig:plot-Nhats-comparison-MUL)). They are pretty close to each other albeit large uncertainties.  
 

```{r plot-Nhats-jags-v5-MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles at MUL when the Bayesian approach, the Phi[.]p[.] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_MUL, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at MUL using MLE (Mark) and the Bayesian approach and the Phi[.]p[.] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```


#### PAO {-}

```{r capture_history_PAO, echo=FALSE}
loc <- "PAO"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps


```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. The entire dataset was used for the analysis, including capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE)` (Figure \@ref(fig:plot-Cap-His-PAO)). 


```{r plot-Cap-His-PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Capture histories of tagged green turtles at PAO. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```

```{r plot-recap-n-PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at PAO. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were `r ncol(Cm.inputs$CJS.data$data)` capture occasions and the number of captured turtles per capture occasion ranged from `r min(n.caught, na.rm = T)` to `r max(n.caught, na.rm = T)` (Figure \@ref(fig:plot-recap-n-PAO)). The number of captures per individual ranged from `r min(rowSums(CJS.data$data))` to `r max(rowSums(CJS.data$data))` with the median of `r median(rowSums(CJS.data$data))` and the mean of `r signif(mean(rowSums(CJS.data$data)), 2)` (Figure \@ref(fig:plot-Cap-n-PAO)). 


```{r plot-Cap-n-PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of times individual green turtles were captured at PAO."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}
```{r model_comp_PAO, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

PAO.models.df <- model.table(Cm.results.Mark) %>% 
  select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```


```{r table-models-PAO, echo=F, include=T}
knitr::kable(PAO.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_PAO, echo=F, message=FALSE, warning=FALSE}

real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 5000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA
plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)

```


Using the best model (Table \@ref(tab:table-models-PAO)), the survival rate was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)`]). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)` to `r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-PAO)).


```{r plot-Nhats-PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles at PAO when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian {-}

```{r parameter_estimates_jags_v5_PAO, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "PAO"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (`r models.MARK.old %>% filter(community == loc) %>% select(model)`), the estimated mean survival rate was `r signif(N.Phi.hats.Jags$Phihats$mean, 3)` (SD = `r signif(N.Phi.hats.Jags$Phihats$sd, 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Phihats$lcl, 3)` - `r signif(N.Phi.hats.Jags$Phihats$ucl, 3)`]).

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r format(signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3), big.mark = ",")` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-jags-v5-PAO)). 

The comparison between estimates from Mark and Jags indicated they were quite different (Mark's estimates were greater than those from Jags, Figure \@ref(fig:plot-Nhats-comparison-PAO)). I would not use these estimates. The x axis goes to >45000 because Jags estimated abundance for some capture occasions that were not estimated by Mark. I think these estimates are not very useful. 


```{r plot-Nhats-jags-v5-PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles at PAO when the Bayesian approach, the Phi[~1]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_PAO, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at PAO using MLE (Mark) and the Bayesian approach and the Phi[.]p[t] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```


#### PLM {-}

```{r capture_history_PLM, echo=FALSE}
loc <- "PLM"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

loc.stats <- capture.recapture.stats(loc, dat.1.Cm.community, Cm.inputs, save.fig,
                                     fig.height = fig.height, fig.width = fig.width)

CJS.data <- loc.stats$CJS.data
n.occ <- loc.stats$n.occ
n.caught <- loc.stats$n.caught
n.caps <- loc.stats$n.caps

```

At `r loc`, there were `r nrow(CJS.data$data)` turtles in the dataset. The entire dataset was used for the analysis, including capture histories of `r nrow(Cm.inputs$CH.1)` individual turtles from `r Cm.inputs$first.sample.date` to `r max(dat.1.Cm.community$DATE)` (Figure \@ref(fig:plot-Cap-His-PLM)). 


```{r plot-Cap-His-PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Capture histories of tagged green turtles at PLM. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```

```{r plot-recap-n-PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of recaptures of green turtles at each capture occasion at PLM. "}
knitr::include_graphics(paste0("figures/Cm_recaptures_", loc, ".png"))
```

There were `r ncol(Cm.inputs$CJS.data$data)` capture occasions and the number of captured turtles per capture occasion ranged from `r min(n.caught, na.rm = T)` to `r max(n.caught, na.rm = T)` (Figure \@ref(fig:plot-recap-n-PLM)). The number of captures per individual ranged from `r min(rowSums(CJS.data$data))` to `r max(rowSums(CJS.data$data))` with the median of `r median(rowSums(CJS.data$data))` and the mean of `r signif(mean(rowSums(CJS.data$data)), 2)` (Figure \@ref(fig:plot-Cap-n-PLM)). 


```{r plot-Cap-n-PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="The number of times individual green turtles were captured at PLM."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark {-}

```{r model_comp_PLM, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

PLM.models.df <- model.table(Cm.results.Mark)%>% select( model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

```{r table-models-PLM, echo=F, include=T}
knitr::kable(PLM.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_PLM, echo=F, message=FALSE, warning=FALSE}

real.estimates <- Cm.results.Mark$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

plot.Nhats.Mark(loc, N.Phi.p.hats.Mark, save.fig, fig.height, fig.width)

```


Using the best model (Table \@ref(tab:table-models-PLM)), the survival rate was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)` (SE = `r signif(N.Phi.p.hats.Mark$Phihats[2, "se"], 3)`, 95% CI = [`r signif(N.Phi.p.hats.Mark$Phihats[2, "lcl"], 2)` - `r signif(N.Phi.p.hats.Mark$Phihats[2, "ucl"], 2)`]). 

The proportion of residents was estimated to be `r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)`, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)` to `r format(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), big.mark = ",")` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-PLM)).


```{r plot-Nhats-PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Estimated abundance of green turtles including transients at PLM when the maximum likelihood approach and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian {-}

```{r parameter_estimates_jags_v5_PLM, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "PLM"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

plot.Nhats.Jags(loc, N.Phi.hats.Jags, save.fig, fig.height, fig.width, ext = "jags_v5.png")

```

Using the best model (`r models.MARK.old %>% filter(community == loc) %>% select(model)`), the estimated mean survival rate of residents was `r signif(N.Phi.hats.Jags$Gammahats[2, "mean"], 3)` (SD = `r signif(N.Phi.hats.Jags$Gammahats[2, "sd"], 3)`, 95% CI = [`r signif(N.Phi.hats.Jags$Gammahats[2, "lcl"], 3)` - `r signif(N.Phi.hats.Jags$Gammahats[2, "ucl"], 2)`]).

The proportion of residents was estimated to be `r signif(N.Phi.hats.Jags$Gammahats[1, "mean"]/N.Phi.hats.Jags$Gammahats[2,"mean"], 3)`, using the two survival rates (one for transients and residents and another for residents only). 

Estimated mean seasonal abundance fluctuated over time, which ranged from `r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)` to `r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)` with large uncertainty, which likely resulted from small numbers of recaptures (Figure \@ref(fig:plot-Nhats-jags-v5-PLM)). 


The comparison between estimates from Mark and Jags indicated they were quite different (Mark's estimates were greater than those from Jags, Figure \@ref(fig:plot-Nhats-comparison-PLM)). I would not use these estimates. 


```{r plot-Nhats-jags-v5-PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = " Estimated abundance of green turtles including transients at PLM when the Bayesian approach, the Phi[TSM]p[t], the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r Nhats_comparison_PLM, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats_comparison(loc, N.Phi.p.hats.Mark, N.Phi.hats.Jags, save.fig,
                 fig.height, fig.width)

#p.Nhats.comparison
```


```{r plot-Nhats-comparison-PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap = "Estimated abundance of green turtles at PLM using MLE (Mark) and the Bayesian approach and the Phi[tsm]p[t] model. Filled circles indicate means and error bars indicate 95% credible or confidence intervals (CI). The red line indicates y = x."}
knitr::include_graphics(paste0("figures/Cm_Nhats_comp_", loc, ".png"))
```

